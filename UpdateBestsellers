DELIMITER $$

CREATE PROCEDURE UpdateBestsellers()
BEGIN
DECLARE NUMBER_OF_BORROWINGS, BKS_ID INT DEFAULT 0;
DECLARE IS_BESTSELLER BOOLEAN;
DECLARE FINISHED INT DEFAULT 0;
DECLARE ALL_IDS CURSOR FOR SELECT BOOK_ID FROM RENTS;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
OPEN ALL_IDS;
WHILE (FINISHED = 0) DO
FETCH ALL_IDS INTO BKS_ID;
IF (FINISHED = 0) THEN
    SELECT COUNT(*) FROM RENTS
    WHERE BOOK_ID = BKS_ID
    INTO NUMBER_OF_BORROWINGS;
IF (NUMBER_OF_BORROWINGS > 2) THEN
    SET IS_BESTSELLER = TRUE;
ELSE
    SET IS_BESTSELLER = FALSE;
    END IF;
    UPDATE BOOKS SET BESTSELLER = IS_BESTSELLER
    WHERE BOOK_ID = BKS_ID;
    COMMIT;
END IF;
END WHILE;
CLOSE ALL_IDS;
END $$

DELIMITER ;
